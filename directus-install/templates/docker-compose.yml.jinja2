version: '3.8'

services:

  cache:
    container_name: directus-cache
    restart: unless-stopped
    image: redis:6

  directus:
    container_name: {{ directus_hostname }}
    hostname: {{ directus_hostname }}
    restart: unless-stopped
    image: directus/directus:9.0.0
    expose:
      - 8055
    volumes:
      - directus-uploads:/directus/uploads
      # If you want to load extensions from the host
      # - ./extensions:/directus/extensions
    depends_on:
      - cache
    environment:
      KEY: {{ directus_key }}
      SECRET: {{ directus_secret }}

      DB_CLIENT: {{ directus_db_client }}
      DB_HOST: {{ directus_db_host }}
      DB_PORT: {{ directus_db_port }}
      DB_DATABASE: {{ directus_db }}
      DB_USER: {{ directus_db_user }}
      DB_PASSWORD: "{{ directus_db_password }}"
      NODE_TLS_REJECT_UNAUTHORIZED: 0
      DB_SSL__REJECT_UNAUTHORIZED: 1
      DB_SSL__CA: "{{ directus_db_ssl_ca }}"

      CACHE_ENABLED: 'true'
      CACHE_STORE: 'redis'
      CACHE_REDIS: 'redis://cache:6379'

      ADMIN_EMAIL: {{ directus_admin_email }}
      ADMIN_PASSWORD: {{ directus_admin_password }}

      # Make sure to set this in production
      # (see https://docs.directus.io/configuration/config-options/#general)
      PUBLIC_URL: 'https://{{ directus_domain }}'

    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "traefik.enable=true" 
      - "traefik.http.routers.directus.rule=Host(`{{ directus_domain }}`)"
      - "traefik.http.routers.directus.entrypoints=websecure"
      - "traefik.http.routers.directus.tls.certresolver=production"


volumes:
  directus-uploads:
    name: {{ directus_hostname }}-directus-uploads


# traefik_network
# --
#
networks:
  default:
    external:
      name: {{ docker_network }}

